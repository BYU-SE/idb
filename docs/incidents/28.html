
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Billing Incident Post-Mortem: Breakdown, Analysis and Root Cause</title>
    <style>
      
body {
  font-family: Helvetica, sans-serif;
}
a, a:visited {
  color:#03e;
}
table {
  border-collapse: collapse;
}
td {
  border: 1px solid #ddd;
  vertical-align:top;
  text-align:left;
  padding:10px;
  line-height:150%;
}
blockquote {
  font-size:125%;
  padding:0px 20px;
  margin:20px 0px;
  border-left:1px solid #ddd;
}
tr.category td {
  font-weight:bold;
  background-color:#ffd;
}
tr.head {
  font-weight:bold;
}
p.footer {
  font-size:75%;
}

    </style>
  </head>
  <body>
  <h1>
    Billing Incident Post-Mortem: Breakdown, Analysis and Root Cause
  </h1>
  
<blockquote>
  &ldquo;This caused all redis-slaves to reconnect and request full synchronization with the master at the same time. Receiving full sync requests from each redis-slave caused the master to suffer extreme load, resulting in performance degradation of the master and timeouts from redis-slaves to redis-master.&rdquo;
</blockquote>

<table>
  <tr>
    <td>
      Incident
    </td>
    <td>
      #28 at 
      <a href="../organizations.html#Twilio">Twilio</a> on 
      <a href="../years.html#2013">2013/07/18</a> 
    </td>
  </tr>
  <tr>
    <td>
      Full report
    </td>
    <td>
      <a href="https://www.twilio.com/blog/2013/07/billing-incident-post-mortem-breakdown-analysis-and-root-cause.html">https://www.twilio.com/blog/2013/07/billing-incident-post-mortem-breakdown-analysis-and-root-cause.html</a>
    </td>
  </tr>

  <tr>
    <td>
      How it happened
    </td>
    <td>
      A loss of network connectivity caused all redis-slaves to simultaneously disconnect from the master, then reconnect and request full synchronization with the master at the same time. The redis-master began to fail due to load generated by synchronization requests. The redis-master was restarted and due to two configuration defects it attempted to restore from a (non-existent) append-only file (AOF), instead of the intended binary snapshop, and started as a slave instead of the primary.
    </td>
  </tr>
  <tr>
    <td>
      Architecture
    </td>
    <td>
      An in-memory Redis cluster (storing account balances) with a single master and multiple slaves distributed across data-centers.
    </td>
  </tr>
  <tr>
    <td>
      Technologies
    </td>
    <td>
      <a href="../technologies.html#Redis">Redis</a>
    </td>
  </tr>
  <tr>
    <td>
      Root cause
    </td>
    <td>
      A loss of network connectivity, led to redis-slaves disconnecting and reconnecting to redis-master with a request for full synchronization. Two configuraiton defects delayed recovery.
    </td>
  </tr>
  <tr>
    <td>
      Failure
    </td>
    <td>
      The redis-master failed (due to load generated by the slave synchronization) as did dependent systems. When the redis-master was restarted it recovered incorrectly and started as a read-only slave.
    </td>
  </tr>
  <tr>
    <td>
      Impact
    </td>
    <td>
      For 1.4% of customers financial payments were not reflected in account balances, some payments were recharged and some accounts were suspended due to those recharges.
    </td>
  </tr>
  <tr>
    <td>
      Mitigation
    </td>
    <td>
      Configuration defects for redis-master were corrected; the redis cluster was restored and refunds for recharges were issued. During mitigation a dependent system was deactivated and then reactivated when mitigation was complete.
    </td>
  </tr>
</table>

  </body>
</html>
