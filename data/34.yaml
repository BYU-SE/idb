properties:

  id: 34
  title: The day we deleted our VM images
  organization: Travis CI
  product: Travis CI
  start_ts: 2016/08/09
  end_ts: 2016/08/16
  author: Konstantin Haase (Chief Technology Officer)
  url: https://blog.travis-ci.com/2016-09-30-the-day-we-deleted-our-vm-images/
  technologies: Google Compute Engine (GCE)
  quote: To avoid running out of space, we have an automated cleanup service in place to delete images that have been removed from our internal image catalog service. You may already see where this is going.
  
structured abstract:

  - name: architecture
    description: Continuous integration tool running build jobs on Linux virtual machines in Google Compute Engine.
    blocks: 10
    
  - name: root cause
    description: Virtual machine image cleanup script that queried a database for a list of valid images (so it knew what not to delete) had a limit of 100 on the query.
    blocks: 14
    
  - name: failure
    description: Deletion of virtual machine images being used in client build jobs.
    blocks: 15
    
  - name: impact
    description: Extended outage and permanent loss of virual machine images, breaking many customer's build jobs.
    blocks: 3
    
  - name: how it happened
    description: To troubleshoot a bug, the clean up process was turned off and in the meantime the organization began creating more virtual machine images than before, including images that had not yet beeen fully tested. The clean up process was turned back on and retrieved from the database a partial list of valid images (due to a limit of 100 on the query). The clean up process then deleted older, but still in use, images (including the images used most).
    blocks: [13,14,15]
  
  - name: mitigation
    description: Recovering deleted virtual machine images was not an option so they rolled forward all jobs to the new (not well tested) images. The engineering team spent more than a week fixing issues that arose.
    blocks: [16,17,25]