properties:

  id: 21
  title: Postmortem for July 27 outage of the Manta service
  organization: Joyent
  product: Manta
  start_ts: 2015/07/27 10:30
  end_ts: 2015/07/27 20:45
  author: The Joyent Team
  url: https://www.joyent.com/blog/manta-postmortem-7-27-2015
  technologies: PostgreSQL
  quote: There was a single 'DROP TRIGGER' query that was attempting to take an exclusive lock on the whole table. It appears that PostgreSQL blocks new attempts to take a shared lock while an exclusive lock is wanted. 

structured abstract:

  - name: architecture
    description: An API layer that calls multiple sharded PostgreSQL databases. Each shard is a three-node PostgreSQL cluster using synchronous replication.
    blocks: [8,9,10]
    
  - name: root cause
    description: During a particular database maintenance operation (vacuuming to prevent transaction id wraparound) any transaction that requests an exclusive lock is blocked and subsequent requests for a shared lock are blocked.
    blocks: [13,30,31]
    
  - name: failure
    description: All transactions on one table on one shard were blocked.
    blocks: 13
    
  - name: impact
    description: API clients experienced high-latency failures (500-level responses) for between 19% and 27% for requests.
    blocks: [4,12]
    
  - name: how it happened
    description: Vacuuming to prevent transaction id wraparound was automatically initiated by the PostgreSQL autovacuuming process. While that was running a ('drop trigger') transaction requested an exclusive lock, blocking until the autovacuuming process completed. Subsequent transactions (requesting a shared lock) blocked behind the 'drop trigger' request causing failures and high latency.
    blocks: [28,29,30]
  
  - name: mitigation
    description: Retune the threshold at which "vacuuming to prevent transaction id wraparound" occurs, temporarily opting to monitor transaction metrics and manually initiate the database maintenance process.
    blocks: 40
    
    